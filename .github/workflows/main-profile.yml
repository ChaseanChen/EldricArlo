name: Generate Profile Assets

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: Create Dist Directory
        run: mkdir -p dist

      - name: Generate Snake
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg?color_snake=#ff79c6&color_dots=#44475a,#6272a4,#bd93f9,#ff79c6,#ffffff
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark&color_snake=#ff79c6&color_dots=#44475a,#6272a4,#bd93f9,#ff79c6,#ffffff

      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER dist
          sudo chmod -R 755 dist

      - name: Generate Random ASCII Art
        shell: python
        run: |
          import random, os, html

          art_dir = "ascii_arts"
          output_dir = "dist"
          fallback_art = "CODE\nLIFE" 

          os.makedirs(output_dir, exist_ok=True)

          selected_art = fallback_art
          if os.path.exists(art_dir):
              files = [f for f in os.listdir(art_dir) if f.endswith('.txt')]
              if files:
                  try:
                      with open(os.path.join(art_dir, random.choice(files)), "r", encoding="utf-8") as f:
                          content = f.read()
                          if content.strip(): selected_art = content
                  except Exception as e:
                      print(f"Error reading ascii file: {e}")

          lines = selected_art.strip("\n").split("\n")
          
          font_family = "Menlo, Consolas, Monaco, monospace"
          line_height = 18
          char_width = 9.6 
          bg_color = "#44475a"
          text_color = "#f8f8f2"
          
          max_chars = max(len(line) for line in lines) if lines else 0
          svg_width = max(600, int(max_chars * char_width + 80)) # 增加左右padding
          svg_height = max(150, len(lines) * line_height + 60)
          
          content_width = max_chars * char_width
          start_x = (svg_width - content_width) / 2
          if start_x < 20: start_x = 20
          
          start_y = (svg_height - (len(lines) * line_height)) / 2 + 14

          tspans = ""
          for i, line in enumerate(lines):

              safe_line = html.escape(line).replace(" ", "&#160;")
              y_pos = start_y + (i * line_height)
              # 关键修复：移除 text-anchor="middle"，使用统一的 x 坐标
              tspans += f'<tspan x="{start_x}" dy="0">{safe_line}</tspan>\n'

          svg_content = f"""<svg fill="none" viewBox="0 0 {svg_width} {svg_height}" width="{svg_width}" height="{svg_height}" xmlns="http://www.w3.org/2000/svg">
            <rect width="100%" height="100%" fill="{bg_color}" rx="10" ry="10" />
            <text font-family="{font_family}" font-weight="bold" font-size="15" fill="{text_color}" y="{start_y}" xml:space="preserve">{tspans}</text>
          </svg>"""

          print(f"Writing to {output_dir}/ascii_art.svg...")
          with open(f"{output_dir}/ascii_art.svg", "w", encoding="utf-8") as f:
              f.write(svg_content)
          print("Success!")

      - name: Install dependencies
        run: pip install requests

      - name: Generate Framed Activity Graph
        shell: python
        env:
          USER_NAME: ${{ github.repository_owner }}
        run: |
          import requests, os, time

          username = os.getenv("USER_NAME")
          url = f"https://github-readme-activity-graph.vercel.app/graph?username={username}&bg_color=44475a&color=f8f8f2&line=ff79c6&point=bd93f9&area=true&hide_border=true"
          output_path = "dist/activity_graph_framed.svg"
          
          content = None
          for i in range(3):
              try:
                  print(f"Fetching graph (attempt {i+1})...")
                  r = requests.get(url, timeout=20)
                  if r.status_code == 200:
                      content = r.text
                      break
              except Exception as e:
                  print(f"Attempt failed: {e}")
                  time.sleep(2)

          if content:
              try:
                  border_style = 'style="border: 2px solid #bd93f9; border-radius: 10px; background: #44475a;"'
                  if '<svg' in content:
                      content = content.replace('<svg', f'<svg {border_style} ', 1)
                  
                  with open(output_path, "w", encoding="utf-8") as f:
                      f.write(content)
                  print("Graph generated successfully.")
              except Exception as e:
                  print(f"Error processing SVG: {e}")
          else:
              print("Failed to fetch graph.")

      - name: Push all assets to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}