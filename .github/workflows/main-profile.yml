name: Generate Profile Assets

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      # 1. æ˜¾å¼åˆ›å»º dist ç›®å½•ï¼Œé˜²æ­¢åç»­æ­¥éª¤æ‰¾ä¸åˆ°ç›®å½•
      - name: Create dist directory
        run: mkdir -p dist

      - name: Generate Snake
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
            dist/github-contribution-grid-snake.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9

      # 2. ä¿®æ”¹ï¼šç”Ÿæˆæ–‡ä»¶åå»æ‰ "dist/" å‰ç¼€ï¼Œç›´æ¥ç”Ÿæˆåœ¨æ ¹ç›®å½•
      #    è¿™æ ·å¯ä»¥é¿å… Docker å®¹å™¨æŒ‚è½½å­ç›®å½•æ—¶çš„æƒé™/è·¯å¾„é—®é¢˜
      - name: Generate 3D Half-Year Calendar
        uses: lowlighter/metrics@latest
        with:
          filename: profile-3d-half-year.svg
          token: ${{ secrets.METRICS_TOKEN }}
          base: ""
          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year
          output_action: none

      # 3. æ–°å¢æ­¥éª¤ï¼šç§»åŠ¨æ–‡ä»¶ã€ä¿®å¤æƒé™ã€å¹¶æ‰“å°æ–‡ä»¶åˆ—è¡¨ä»¥ä¾¿è°ƒè¯•
      - name: Move 3D file and Fix permissions
        run: |
          # æ£€æŸ¥æ ¹ç›®å½•ä¸‹æ˜¯å¦æœ‰ç”Ÿæˆçš„æ–‡ä»¶
          if [ -f "profile-3d-half-year.svg" ]; then
            mv profile-3d-half-year.svg dist/
            echo "âœ… 3D Graph generated and moved successfully."
          else
            echo "âŒ Error: profile-3d-half-year.svg was not found in root directory!"
            # ä¸å¼ºåˆ¶é€€å‡ºï¼Œå…è®¸å…¶ä»–æ­¥éª¤ç»§ç»­ï¼Œä½†ä¼šåœ¨æ—¥å¿—é‡ŒæŠ¥é”™
          fi

          # ç»Ÿä¸€ä¿®å¤ dist ç›®å½•æƒé™ (Docker ç”Ÿæˆçš„æ–‡ä»¶é€šå¸¸æ˜¯ root æƒé™)
          if [ -d "dist" ]; then
            sudo chown -R $USER:$USER dist
          fi

          # è°ƒè¯•ï¼šåˆ—å‡º dist ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œè¯·åœ¨ Actions æ—¥å¿—ä¸­æŸ¥çœ‹è¿™ä¸€æ­¥çš„è¾“å‡º
          echo "ğŸ“‚ Listing files in dist directory:"
          ls -l dist/

      - name: Generate Random ASCII Art
        shell: python
        run: |
          import random
          import os
          import html

          art_dir = "ascii_arts"
          output_dir = "dist"
          fallback_art = "Hello\nWorld" 

          # dist ç›®å½•åœ¨ä¸Šé¢å·²ç»åˆ›å»ºï¼Œè¿™é‡Œç›´æ¥ç”¨
          if not os.path.exists(output_dir):
              os.makedirs(output_dir)

          selected_art = fallback_art
          if not os.path.exists(art_dir):
              print(f"Warning: Directory '{art_dir}' not found.")
          else:
              files = [f for f in os.listdir(art_dir) if f.endswith('.txt')]
              if not files:
                  print("Warning: No .txt files found.")
              else:
                  selected_file = random.choice(files)
                  try:
                      with open(os.path.join(art_dir, selected_file), "r", encoding="utf-8") as f:
                          selected_art = f.read()
                  except Exception as e:
                      print(f"Error: {e}")

          lines = selected_art.strip("\n").split("\n")
          
          line_height_px = 18 
          padding_y = 60 
          char_width_px = 9.2 
          
          max_chars = max(len(line) for line in lines)
          art_width_px = max_chars * char_width_px
          
          svg_width = max(600, int(art_width_px + 100))
          final_height = max(200, len(lines) * line_height_px + padding_y)
          start_x = (svg_width - art_width_px) / 2
          
          tspans = "".join([f'<tspan x="{start_x}" dy="1.2em">{html.escape(line)}</tspan>' for line in lines])

          svg_content = f"""<svg fill="none" viewBox="0 0 {svg_width} {final_height}" width="{svg_width}" height="{final_height}" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="{svg_width-4}" height="{final_height-4}" fill="#44475a" rx="20" ry="20" stroke="#ffffff" stroke-width="2" />
            <text x="{start_x}" y="40" font-family="monospace" font-weight="bold" font-size="15" fill="#f8f8f2" xml:space="preserve">{tspans}</text>
          </svg>"""

          with open(f"{output_dir}/ascii_art.svg", "w", encoding="utf-8") as f:
              f.write(svg_content)

      - name: Install dependencies
        run: pip install requests

      - name: Generate Framed Activity Graph
        shell: python
        env:
          USER_NAME: ${{ github.repository_owner }}
        run: |
          import requests
          import os

          username = os.getenv("USER_NAME")
          url = f"https://github-readme-activity-graph.vercel.app/graph?username={username}&bg_color=44475a&color=f8f8f2&line=ff79c6&point=bd93f9&area=true&hide_border=true"
          
          try:
              response = requests.get(url, timeout=10)
              if response.status_code == 200:
                  svg = response.text
                  
                  border_color = "#ffffff"
                  border_width = "2"
                  
                  border_rect = f'<rect x="1" y="1" width="99%" height="98%" fill="none" stroke="{border_color}" stroke-width="{border_width}" rx="20" ry="20" />'
                  if "</svg>" in svg:
                      svg = svg.replace("</svg>", f"{border_rect}</svg>")
                      
                  svg = svg.replace("<svg ", '<svg style="border-radius:20px;" ')

                  with open("dist/activity_graph_framed.svg", "w", encoding="utf-8") as f:
                      f.write(svg)
          except Exception as e:
              print(f"Failed to generate graph: {e}")

      - name: Push all assets to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}