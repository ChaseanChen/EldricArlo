name: Debug Token Validity

on: workflow_dispatch

jobs:
  check-token:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Check if Secret exists
        env:
          TEST_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          if [ -z "$TEST_TOKEN" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯: ä½ æ²¡æœ‰è®¾ç½®åä¸º METRICS_TOKEN çš„ Secretï¼"
            echo "è¯·å» Settings -> Secrets and variables -> Actions æ·»åŠ å®ƒã€‚"
            exit 1
          else
            echo "âœ… Secret å­˜åœ¨ (æ£€æµ‹åˆ°å·²å¡«å…¥å†…å®¹)"
          fi

      - name: 2. Verify Token Permissions (Crucial!)
        env:
          GH_TOKEN: ${{ secrets.METRICS_TOKEN }}
        run: |
          echo "æ­£åœ¨æ£€æŸ¥ Token æƒé™..."
          
          # ä½¿ç”¨ GitHub CLI æ£€æŸ¥å½“å‰ Token çš„æƒé™èŒƒå›´
          SCOPES=$(gh api user -H "Accept: application/vnd.github+json" --include | grep -i "x-oauth-scopes")
          
          echo "=========================================="
          echo "ä½ çš„ Token æ‹¥æœ‰çš„æƒé™: $SCOPES"
          echo "=========================================="
          
          # æ£€æŸ¥å…³é”®æƒé™
          if [[ "$SCOPES" != *"read:user"* ]]; then
             echo "âŒ å¤±è´¥: ç¼ºå°‘ 'read:user' æƒé™ï¼"
             echo "åŸå› : Metrics æ’ä»¶æ— æ³•è¯»å–ä½ çš„ä¸ªäººèµ„æ–™ï¼ˆå¦‚è´¦æˆ·åˆ›å»ºæ—¶é—´ï¼‰ï¼Œå¯¼è‡´ç”Ÿæˆå¤±è´¥ã€‚"
             FAILED=1
          else
             echo "âœ… 'read:user' æƒé™æ­£å¸¸ã€‚"
          fi

          if [[ "$SCOPES" != *"repo"* ]]; then
             echo "âŒ å¤±è´¥: ç¼ºå°‘ 'repo' æƒé™ï¼"
             echo "åŸå› : Metrics æ’ä»¶æ— æ³•è¯»å–ä½ çš„ç§æœ‰è´¡çŒ®ã€‚"
             FAILED=1
          else
             echo "âœ… 'repo' æƒé™æ­£å¸¸ã€‚"
          fi

          if [ "$FAILED" == "1" ]; then
            echo "------------------------------------------"
            echo "ğŸ’¡ è§£å†³åŠæ³•ï¼š"
            echo "1. å» https://github.com/settings/tokens é‡æ–°ç”Ÿæˆ Tokenã€‚"
            echo "2. åŠ¡å¿…å‹¾é€‰ 'repo' å’Œ 'read:user' (åœ¨ User æ ç›®ä¸‹)ã€‚"
            echo "3. å›åˆ°ä»“åº“ Settings æ›´æ–° METRICS_TOKENã€‚"
            exit 1
          fi

      - name: 3. Test Metrics Plugin (Dry Run)
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: ChaseanChen
          dryrun: yes
          verify: yes
          debug: yes