name: Generate Profile Assets

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: Create Dist Directory
        run: mkdir -p dist

      - name: Generate Snake
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg?color_snake=#ff79c6&color_dots=#44475a,#6272a4,#bd93f9,#ff79c6,#ffffff
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark&color_snake=#ff79c6&color_dots=#44475a,#6272a4,#bd93f9,#ff79c6,#ffffff

      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER dist
          sudo chmod -R 755 dist

      - name: Generate Random ASCII Art
        shell: python
        run: |
          import random, os, html

          art_dir = "ascii_arts"
          output_dir = "dist"
          fallback_art = "CODE\nLIFE" 

          if not os.path.exists(output_dir):
              os.makedirs(output_dir)

          selected_art = fallback_art
          if os.path.exists(art_dir):
              files = [f for f in os.listdir(art_dir) if f.endswith('.txt')]
              if files:
                  try:
                      with open(os.path.join(art_dir, random.choice(files)), "r", encoding="utf-8") as f:
                          content = f.read().rstrip()
                          if content.strip(): selected_art = content
                  except Exception:
                      pass

          lines = selected_art.split("\n")
          
          font_family = "SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace"
          font_size = 14
          line_height = 1.2
          char_width_px = font_size * 0.61
          line_height_px = font_size * line_height
          
          padding_x = 40
          padding_y = 40
          
          max_chars = max(len(line) for line in lines) if lines else 0
          art_width_px = max_chars * char_width_px
          art_height_px = len(lines) * line_height_px
          
          svg_width = int(art_width_px + padding_x * 2)
          svg_height = int(art_height_px + padding_y * 2)
          
          start_x = padding_x
          start_y = padding_y + font_size 

          tspans = ""
          for i, line in enumerate(lines):
              safe_line = html.escape(line).replace(" ", "&#160;")
              dy = f'{line_height}em' if i > 0 else "0"
              tspans += f'<tspan x="{start_x}" dy="{dy}">{safe_line}</tspan>'

          svg_content = f"""<svg fill="none" viewBox="0 0 {svg_width} {svg_height}" width="{svg_width}" height="{svg_height}" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <rect x="2" y="2" width="{svg_width-4}" height="{svg_height-4}" fill="#282a36" rx="15" ry="15" stroke="#ff79c6" stroke-width="2" stroke-opacity="0.6"/>
            <text x="{start_x}" y="{start_y}" font-family="{font_family}" font-weight="bold" font-size="{font_size}" fill="#f8f8f2" filter="url(#glow)">{tspans}</text>
          </svg>"""

          with open(f"{output_dir}/ascii_art.svg", "w", encoding="utf-8") as f:
              f.write(svg_content)

      - name: Install dependencies
        run: pip install requests

      - name: Generate Activity Graph Locally
        shell: python
        env:
          USER_NAME: ${{ github.repository_owner }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          import os
          import requests
          import math
          
          USERNAME = os.getenv("USER_NAME")
          TOKEN = os.getenv("GITHUB_TOKEN")
          OUTPUT_PATH = "dist/activity_graph_framed.svg"
          
          COLOR_BG = "#44475a"
          COLOR_LINE = "#ff79c6"
          COLOR_POINT = "#bd93f9"
          COLOR_AREA = "#ff79c6"
          COLOR_TEXT = "#f8f8f2"
          
          DAYS_TO_SHOW = 31
          WIDTH = 800
          HEIGHT = 150
          PADDING = 20
          GRAPH_HEIGHT = 80
          
          def fetch_contributions():
              query = """
              query($user: String!) {
                user(login: $user) {
                  contributionsCollection {
                    contributionCalendar {
                      weeks {
                        contributionDays {
                          contributionCount
                        }
                      }
                    }
                  }
                }
              }
              """
              headers = {"Authorization": f"Bearer {TOKEN}"}
              r = requests.post("https://api.github.com/graphql", json={"query": query, "variables": {"user": USERNAME}}, headers=headers)
              if r.status_code != 200:
                  raise Exception(f"GitHub API Error: {r.status_code}")
              
              data = r.json()
              weeks = data["data"]["user"]["contributionsCollection"]["contributionCalendar"]["weeks"]
              
              all_days = []
              for week in weeks:
                  for day in week["contributionDays"]:
                      all_days.append(day)
              
              return all_days[-DAYS_TO_SHOW:]

          def generate_svg(data):
              counts = [d['contributionCount'] for d in data]
              max_count = max(counts) if counts else 1
              if max_count == 0: max_count = 1
              
              points = []
              step_x = (WIDTH - 2 * PADDING) / (len(counts) - 1) if len(counts) > 1 else 0
              
              for i, count in enumerate(counts):
                  x = PADDING + i * step_x
                  y = (HEIGHT - PADDING) - (count / max_count * GRAPH_HEIGHT)
                  points.append((x, y))

              path_d = f"M {points[0][0]},{points[0][1]} "
              for p in points[1:]:
                  path_d += f"L {p[0]},{p[1]} "
              
              area_d = path_d + f"L {points[-1][0]},{HEIGHT-PADDING} L {points[0][0]},{HEIGHT-PADDING} Z"

              circles = ""
              for p in points:
                  circles += f'<circle cx="{p[0]}" cy="{p[1]}" r="3" fill="{COLOR_BG}" stroke="{COLOR_POINT}" stroke-width="2" />'

              svg_content = f"""
              <svg fill="none" viewBox="0 0 {WIDTH} {HEIGHT}" width="{WIDTH}" height="{HEIGHT}" xmlns="http://www.w3.org/2000/svg">
                <style>
                  .text {{ font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif; font-size: 10px; fill: {COLOR_TEXT}; }}
                </style>
                <rect x="0" y="0" width="{WIDTH}" height="{HEIGHT}" rx="10" ry="10" fill="{COLOR_BG}" />
                <text x="{PADDING}" y="{PADDING + 10}" class="text" font-weight="bold" font-size="14">Activity (Last 31 Days)</text>
                <path d="{area_d}" fill="{COLOR_AREA}" fill-opacity="0.2" />
                <path d="{path_d}" fill="none" stroke="{COLOR_LINE}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" />
                {circles}
              </svg>
              """
              return svg_content

          try:
              days = fetch_contributions()
              svg = generate_svg(days)
              with open(OUTPUT_PATH, "w", encoding="utf-8") as f:
                  f.write(svg)
          except Exception as e:
              print(f"Error: {e}")
              exit(1)

      - name: Push all assets to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}