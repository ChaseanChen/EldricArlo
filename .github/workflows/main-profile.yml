name: Generate Profile Assets

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      - name: Create Dist Directory
        run: mkdir -p dist

      - name: Generate Snake
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg?color_snake=#ff79c6&color_dots=#44475a,#6272a4,#bd93f9,#ff79c6,#ffffff
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark&color_snake=#ff79c6&color_dots=#44475a,#6272a4,#bd93f9,#ff79c6,#ffffff

      - name: Fix permissions
        run: |
          sudo chown -R $USER:$USER dist
          sudo chmod -R 755 dist

      - name: Generate Random ASCII Art
        shell: python
        run: |
          import random, os, html

          art_dir = "ascii_arts"
          output_dir = "dist"
          fallback_art = "CODE\nLIFE" 

          if not os.path.exists(output_dir):
              os.makedirs(output_dir)

          selected_art = fallback_art
          if os.path.exists(art_dir):
              files = [f for f in os.listdir(art_dir) if f.endswith('.txt')]
              if files:
                  try:
                      with open(os.path.join(art_dir, random.choice(files)), "r", encoding="utf-8") as f:
                          content = f.read().rstrip()
                          if content.strip(): selected_art = content
                  except Exception:
                      pass

          lines = selected_art.split("\n")
          
          font_family = "SFMono-Regular, Consolas, 'Liberation Mono', Menlo, monospace"
          font_size = 14
          line_height = 1.2
          char_width_px = font_size * 0.61
          line_height_px = font_size * line_height
          
          padding_x = 40
          padding_y = 40
          
          max_chars = max(len(line) for line in lines) if lines else 0
          art_width_px = max_chars * char_width_px
          art_height_px = len(lines) * line_height_px
          
          svg_width = int(art_width_px + padding_x * 2)
          svg_height = int(art_height_px + padding_y * 2)
          
          start_x = padding_x
          start_y = padding_y + font_size 

          tspans = ""
          for i, line in enumerate(lines):
              safe_line = html.escape(line).replace(" ", "&#160;")
              dy = f'{line_height}em' if i > 0 else "0"
              tspans += f'<tspan x="{start_x}" dy="{dy}">{safe_line}</tspan>'

          svg_content = f"""<svg fill="none" viewBox="0 0 {svg_width} {svg_height}" width="{svg_width}" height="{svg_height}" xmlns="http://www.w3.org/2000/svg">
            <defs>
              <filter id="glow" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                <feMerge>
                  <feMergeNode in="coloredBlur"/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>
            <rect x="2" y="2" width="{svg_width-4}" height="{svg_height-4}" fill="#282a36" rx="15" ry="15" />
            <text x="{start_x}" y="{start_y}" font-family="{font_family}" font-weight="bold" font-size="{font_size}" fill="#f8f8f2" filter="url(#glow)">{tspans}</text>
          </svg>"""

          with open(f"{output_dir}/ascii_art.svg", "w", encoding="utf-8") as f:
              f.write(svg_content)

      - name: Install dependencies
        run: pip install requests

      - name: Generate Framed Activity Graph
        shell: python
        env:
          USER_NAME: ${{ github.repository_owner }}
        run: |
          import requests, os, time, re

          username = os.getenv("USER_NAME")
          url = f"https://github-readme-activity-graph.vercel.app/graph?username={username}&color=f8f8f2&line=ff79c6&point=bd93f9&area=true&hide_border=true&hide_title=true"
          fallback_url = f"https://raw.githubusercontent.com/{username}/{username}/output/activity_graph_framed.svg"
          output_path = "dist/activity_graph_framed.svg"
          headers = {'User-Agent': 'Mozilla/5.0'}

          def save_file(data):
              with open(output_path, "w", encoding="utf-8") as f:
                  f.write(data)

          content = None
          
          for i in range(4):
              try:
                  r = requests.get(url, headers=headers, timeout=30)
                  if r.status_code == 200 and len(r.text) > 100:
                      content = r.text
                      break
              except Exception:
                  time.sleep(3)

          if not content:
              try:
                  r = requests.get(fallback_url, timeout=20)
                  if r.status_code == 200:
                      content = r.text
              except:
                  pass

          if content:
              w_match = re.search(r'width=["\']([\d\.]+)["\']', content)
              h_match = re.search(r'height=["\']([\d\.]+)["\']', content)
              
              if w_match and h_match:
                  width = float(w_match.group(1))
                  height = float(h_match.group(1))
                  bg_rect = f'<rect x="0" y="0" width="{width}" height="{height}" rx="10" ry="10" fill="#44475a" />'
                  final_content = re.sub(r'(<svg[^>]*>)', r'\1' + bg_rect, content, count=1)
                  save_file(final_content)
              else:
                  save_file(content)
          else:
              placeholder = """<svg width="800" height="150" xmlns="http://www.w3.org/2000/svg">
                <rect width="800" height="150" rx="10" ry="10" fill="#44475a" />
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="monospace" font-size="20" fill="#ff79c6">Graph Temporarily Unavailable</text>
              </svg>"""
              save_file(placeholder)

      - name: Push all assets to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}