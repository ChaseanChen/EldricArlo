name: Generate Profile Assets

on:
  schedule:
    - cron: "0 */12 * * *"
  workflow_dispatch:
  push:
    branches:
      - main
      - master

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - uses: actions/checkout@v4

      # 1. èµ‹äºˆå½“å‰ç›®å½•æœ€é«˜æƒé™ï¼Œé˜²æ­¢ Docker å†™å…¥å¤±è´¥
      - name: Fix Directory Permissions
        run: |
          mkdir -p dist
          sudo chmod -R 777 .

      # 2. ç”Ÿæˆè´ªåƒè›‡
      - name: Generate Snake
        uses: Platane/snk@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark
            dist/github-contribution-grid-snake.gif?color_snake=orange&color_dots=#bfd6f6,#8dbdff,#64a1f4,#4b91f1,#3c7dd9

      # 3. ç”Ÿæˆ Metrics (æ ¸å¿ƒä¿®å¤)
      # ç­–ç•¥ï¼šç”Ÿæˆåˆ°æ ¹ç›®å½•ï¼Œå¼€å¯ verify å’Œ debug
      - name: Generate Half-Year Metrics
        uses: lowlighter/metrics@latest
        with:
          token: ${{ secrets.METRICS_TOKEN }}
          user: ChaseanChen
          template: classic
          base: header, activity, community, repositories, metadata
          config_timezone: Asia/Shanghai
          plugin_isocalendar: yes
          plugin_isocalendar_duration: half-year
          
          # å…³é”®ç‚¹ï¼šåªå†™æ–‡ä»¶åï¼Œä¸å†™è·¯å¾„ï¼Œå‡å°‘æƒé™é”™è¯¯
          filename: metrics.svg
          output_action: none
          
          # å¼ºåˆ¶æ‰“å°è°ƒè¯•ä¿¡æ¯ï¼Œå¦‚æœæœ‰ API é”™è¯¯ä¼šç›´æ¥æ˜¾ç¤º
          debug: yes
          verify: yes

      # 4. ã€å¯»å®æ¨¡å¼ã€‘åœ°æ¯¯å¼æœç´¢æ–‡ä»¶
      # ä¸ç®¡æ–‡ä»¶ç”Ÿæˆåˆ°å“ªé‡Œäº†ï¼Œåªè¦å­˜åœ¨ï¼Œå°±æŠŠå®ƒç§»åŠ¨åˆ° dist
      - name: Locate and Move Metrics
        run: |
          echo "ğŸ” æ­£åœ¨å¯»æ‰¾ metrics.svg ..."
          
          # åœ¨å½“å‰ç›®å½•æŸ¥æ‰¾æ–‡ä»¶
          FOUND_FILE=$(find . -name "metrics.svg" -type f | head -n 1)
          
          if [ -z "$FOUND_FILE" ]; then
            echo "âŒ ä¸¥é‡é”™è¯¯ï¼šåœ¨ä»»ä½•ç›®å½•ä¸‹éƒ½æ‰¾ä¸åˆ° metrics.svgï¼"
            echo "---------------------------------------------------"
            echo "è¿™æ„å‘³ç€ Generate æ­¥éª¤è™½ç„¶æ˜¾ç¤ºç»¿è‰²ï¼Œä½†å®é™…ä¸Šæ²¡æœ‰è¾“å‡ºæ–‡ä»¶ã€‚"
            echo "è¯·åŠ¡å¿…æŸ¥çœ‹ä¸Šä¸€æ­¥çš„æ—¥å¿—ã€‚"
            echo "---------------------------------------------------"
            ls -R # åˆ—å‡ºæ‰€æœ‰æ–‡ä»¶ä¾›è°ƒè¯•
            exit 1
          else
            echo "âœ… æ‰¾åˆ°äº†æ–‡ä»¶ï¼š$FOUND_FILE"
            echo "æ­£åœ¨ç§»åŠ¨åˆ° dist/metrics.svg ..."
            mv "$FOUND_FILE" dist/metrics.svg
          fi

      # 5. Python å¤„ç†ï¼šç»™ dist/metrics.svg åŠ è¾¹æ¡†
      - name: Style Metrics
        shell: python
        run: |
          import os
          import sys

          # æ­¤æ—¶æ–‡ä»¶ä¸€å®šåœ¨ dist é‡Œ
          target_file = 'dist/metrics.svg'

          if not os.path.exists(target_file):
              print(f"âŒ é”™è¯¯: {target_file} ä¸å­˜åœ¨ (é€»è¾‘ä¸å¯èƒ½åˆ°è¾¾è¿™é‡Œ)")
              sys.exit(1)
          
          print("âœ… å¼€å§‹ä¸º SVG æ·»åŠ æ ·å¼...")

          try:
              with open(target_file, 'r', encoding='utf-8') as f:
                  svg_content = f.read()

              # 1. æ³¨å…¥èƒŒæ™¯è‰²å’Œåœ†è§’
              if '<svg ' in svg_content:
                  # ç®€å•æš´åŠ›çš„æ›¿æ¢ï¼Œé˜²æ­¢æ­£åˆ™åŒ¹é…å¤±è´¥
                  svg_content = svg_content.replace('<svg ', '<svg style="border-radius:20px; background-color: #44475a;" ')
              
              # 2. æ³¨å…¥ç™½è‰²è¾¹æ¡†
              border_rect = '<rect x="1" y="1" width="99%" height="98%" fill="none" stroke="#ffffff" stroke-width="2" rx="20" ry="20" />'
              
              if "</svg>" in svg_content and "stroke-width=\"2\" rx=\"20\"" not in svg_content:
                  svg_content = svg_content.replace("</svg>", f"{border_rect}</svg>")

              with open(target_file, 'w', encoding='utf-8') as f:
                  f.write(svg_content)
              
              print(f"âœ… æ ·å¼æ·»åŠ æˆåŠŸï¼")

          except Exception as e:
              print(f"âŒ å¤„ç† SVG æ—¶å‡ºé”™: {e}")
              sys.exit(1)

      - name: Generate Random ASCII Art
        shell: python
        run: |
          import random
          import os
          import html

          art_dir = "ascii_arts"
          output_dir = "dist"
          fallback_art = "Hello\nWorld" 
          
          selected_art = fallback_art
          if os.path.exists(art_dir):
              files = [f for f in os.listdir(art_dir) if f.endswith('.txt')]
              if files:
                  selected_file = random.choice(files)
                  try:
                      with open(os.path.join(art_dir, selected_file), "r", encoding="utf-8") as f:
                          selected_art = f.read()
                  except:
                      pass
          
          lines = selected_art.strip("\n").split("\n")
          line_height_px = 18 
          padding_y = 60 
          char_width_px = 9.2 
          max_chars = max(len(line) for line in lines)
          art_width_px = max_chars * char_width_px
          svg_width = max(600, int(art_width_px + 100))
          final_height = max(200, len(lines) * line_height_px + padding_y)
          start_x = (svg_width - art_width_px) / 2
          tspans = "".join([f'<tspan x="{start_x}" dy="1.2em">{html.escape(line)}</tspan>' for line in lines])

          svg_content = f"""<svg fill="none" viewBox="0 0 {svg_width} {final_height}" width="{svg_width}" height="{final_height}" xmlns="http://www.w3.org/2000/svg">
            <rect x="2" y="2" width="{svg_width-4}" height="{final_height-4}" fill="#44475a" rx="20" ry="20" stroke="#ffffff" stroke-width="2" />
            <text x="{start_x}" y="40" font-family="monospace" font-weight="bold" font-size="15" fill="#f8f8f2" xml:space="preserve">{tspans}</text>
          </svg>"""

          with open(f"{output_dir}/ascii_art.svg", "w", encoding="utf-8") as f:
              f.write(svg_content)

      - name: Install dependencies
        run: pip install requests

      - name: Generate Framed Activity Graph
        shell: python
        env:
          USER_NAME: ${{ github.repository_owner }}
        run: |
          import requests
          import os
          username = os.getenv("USER_NAME")
          url = f"https://github-readme-activity-graph.vercel.app/graph?username={username}&bg_color=44475a&color=f8f8f2&line=ff79c6&point=bd93f9&area=true&hide_border=true"
          try:
              response = requests.get(url, timeout=10)
              if response.status_code == 200:
                  svg = response.text
                  border_rect = '<rect x="1" y="1" width="99%" height="98%" fill="none" stroke="#ffffff" stroke-width="2" rx="20" ry="20" />'
                  if "</svg>" in svg:
                      svg = svg.replace("</svg>", f"{border_rect}</svg>")
                  svg = svg.replace("<svg ", '<svg style="border-radius:20px;" ')
                  with open("dist/activity_graph_framed.svg", "w", encoding="utf-8") as f:
                      f.write(svg)
          except:
              pass

      - name: Push all assets to output branch
        uses: crazy-max/ghaction-github-pages@v4
        with:
          target_branch: output
          build_dir: dist
          keep_history: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}